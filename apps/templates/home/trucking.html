{# home/templates/home/trucking.html #}
{% extends "home/base.html" %}   {# Or whatever your base template is called #}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Trucking Dashboard</h2>
  <ul class="nav nav-tabs mt-3" id="truckingTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link {% if selected_tab == 'hub' %}active{% endif %}"
         href="{% url 'trucking_hub' %}?tab=hub">Hub</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if selected_tab == 'files' %}active{% endif %}"
         href="{% url 'trucking_hub' %}?tab=files">Files</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if selected_tab == 'add' %}active{% endif %}"
         href="{% url 'trucking_hub' %}?tab=add">Add Expense/Load</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if selected_tab == 'accounting' %}active{% endif %}"
         href="{% url 'trucking_hub' %}?tab=accounting">Accounting</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if selected_tab == 'active_loads' %}active{% endif %}"
         href="{% url 'trucking_hub' %}?tab=active_loads">Active Loads</a>
    </li>
  </ul>

  <div class="tab-content mt-4">
    {# ======= HUB TAB ======= #}
    {% if selected_tab == 'hub' %}
      <div class="tab-pane fade show active">
        <h4 class="mb-3">Overview</h4>
        <p><strong>Total Revenue:</strong> ${{ total_revenue|floatformat:2 }}</p>
        <p><strong>Total Expenses:</strong> ${{ total_expenses|floatformat:2 }}</p>
        <p><strong>Net Profit:</strong> ${{ net_profit|floatformat:2 }}</p>

        <hr>
        <h5>Per-Truck Summary</h5>
        <table class="table table-bordered table-sm">
          <thead class="thead-light">
            <tr>
              <th>Truck</th>
              <th>Total Revenue</th>
              <th>Total Expenses</th>
              <th>Profit</th>
              <th>Active Loads</th>
            </tr>
          </thead>
          <tbody>
            {% for item in per_truck %}
              <tr>
                <td>{{ item.truck.name }}</td>
                <td>${{ item.revenue_total|floatformat:2 }}</td>
                <td>${{ item.expense_total|floatformat:2 }}</td>
                <td>${{ item.profit|floatformat:2 }}</td>
                <td>{{ item.active_loads }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5">No trucks yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {# ======= FILES TAB ======= #}
    {% if selected_tab == 'files' %}
      <div class="tab-pane fade show active">
        <h4>Upload Truck Documents</h4>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-row">
            <div class="col-md-4">
              {{ file_form.truck.label_tag }} 
              {{ file_form.truck }}
            </div>
            <div class="col-md-4">
              {{ file_form.title.label_tag }} 
              {{ file_form.title }}
            </div>
            <div class="col-md-4">
              {{ file_form.file.label_tag }} 
              {{ file_form.file }}
            </div>
          </div>
          <button type="submit" class="btn btn-primary mt-2">Upload File</button>
        </form>

        <hr>
        <h5 class="mt-4">Existing Files</h5>
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>Truck</th>
              <th>Title</th>
              <th>Uploaded At</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody>
            {% for f in files %}
              <tr>
                <td>{{ f.truck.name }}</td>
                <td>{{ f.title }}</td>
                <td>{{ f.uploaded_at|date:"Y-m-d H:i" }}</td>
                <td>
                  <a href="{{ f.file.url }}" class="btn btn-sm btn-outline-secondary" target="_blank">Download</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No files uploaded yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {# ======= ADD EXPENSE/LOAD TAB ======= #}
    {% if selected_tab == 'add' %}
      <div class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-6">
            <h4>Add Expense</h4>
            <form method="post">
              {% csrf_token %}
              {{ expense_form.as_p }}
              <button type="submit" name="add_expense" class="btn btn-success">Save Expense</button>
            </form>
          </div>
          <div class="col-md-6">
            <h4>Add Load</h4>
            <form method="post">
              {% csrf_token %}
              {{ load_form.as_p }}
              <button type="submit" name="add_load" class="btn btn-success">Save Load</button>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {# ======= ACCOUNTING TAB ======= #}
    {% if selected_tab == 'accounting' %}
      <div class="tab-pane fade show active">
        <h4>All Expenses</h4>
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>Truck</th>
              <th>Description</th>
              <th>Category</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for exp in all_expenses %}
              <tr>
                <td>{{ exp.date_incurred }}</td>
                <td>{{ exp.truck.name }}</td>
                <td>{{ exp.description }}</td>
                <td>{{ exp.category }}</td>
                <td>${{ exp.amount|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5">No expenses recorded.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <hr class="my-4">

        <h4>All Loads</h4>
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Start Date</th>
              <th>Completed Date</th>
              <th>Truck</th>
              <th>Customer</th>
              <th>Pay</th>
              <th>Miles</th>
              <th>Total Hours</th>
              <th>Load/Unload Hours</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for load in all_loads %}
              <tr>
                <td>{{ load.date_started }}</td>
                <td>{{ load.date_completed|default:"â€”" }}</td>
                <td>{{ load.truck.name }}</td>
                <td>{{ load.customer }}</td>
                <td>${{ load.pay_amount|floatformat:2 }}</td>
                <td>{{ load.miles }}</td>
                <td>{{ load.hours_total }}</td>
                <td>{{ load.hours_load_unload }}</td>
                <td>{{ load.get_status_display }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="9">No loads recorded.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {# ======= ACTIVE LOADS TAB ======= #}
    {% if selected_tab == 'active_loads' %}
      <div class="tab-pane fade show active">
        <h4>Active Loads</h4>
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Truck</th>
              <th>Date Started</th>
              <th>Customer</th>
              <th>Pay</th>
              <th>Miles</th>
              <th>Hours Total</th>
              <th>Load/Unload Hours</th>
              <th>Mark Completed</th>
            </tr>
          </thead>
          <tbody>
            {% for load in active_loads %}
              <tr>
                <td>{{ load.truck.name }}</td>
                <td>{{ load.date_started }}</td>
                <td>{{ load.customer }}</td>
                <td>${{ load.pay_amount|floatformat:2 }}</td>
                <td>{{ load.miles }}</td>
                <td>{{ load.hours_total }}</td>
                <td>{{ load.hours_load_unload }}</td>
                <td>
                  <form method="post" action="{% url 'trucking_hub' %}?tab=active_loads">
                    {% csrf_token %}
                    <input type="hidden" name="load_id" value="{{ load.id }}">
                    <input type="hidden" name="mark_complete" value="true">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                      Complete
                    </button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="8">No active loads at the moment.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
