{% extends 'layouts/base.html' %}
{% load static %}
{% load markdown_extras %}
{% block title %}Conversation - {{ conversation.title }}{% endblock title %}

{% block stylesheets %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 70px);
    }
    .sidebar {
        width: 180px;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
    }
    .chat-window {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    .messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    .message {
        margin-bottom: 15px;
        display: flex;
    }
    .message-content {
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
    }
    .message.user {
        justify-content: flex-end;
    }
    .message.assistant {
        justify-content: flex-start;
    }
    .message.user .message-content {
        background-color: rgba(173, 216, 230, 0.7); /* Light blue */
        color: #000;
    }
    .message.assistant .message-content {
        background-color: rgba(211, 211, 211, 0.7); /* Light grey */
        color: #000;
    }
    .message-content {
        border: 1px solid rgba(0, 0, 0, 0.1);
        position: relative;
    }
    /* Code block styling */
    pre {
        background-color: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
        position: relative;
    }
    pre code {
        display: block;
    }
    /* Copy button styling */
    .copy-button {
        position: absolute;
        right: 10px;
        top: 10px;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        background-color: #e1e1e8;
        border: none;
        border-radius: 5px;
    }
    /* Table styling */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1em;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    th {
        background-color: #f2f2f2;
    }
    tr:nth-child(even){
        background-color: #f9f9f9;
    }
</style>
<!-- Include Highlight.js styles -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
{% endblock stylesheets %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Conversations</h2>
        <ul class="list-group">
            {% for conv in request.user.conversations.all %}
                <li class="list-group-item {% if conv.id == conversation.id %}active{% endif %}">
                    <a href="{% url 'conversation_detail' conv.id %}">{{ conv.title }}</a>
                </li>
            {% endfor %}
        </ul>
        <a href="{% url 'conversation_list' %}" class="btn btn-primary mt-3">+ New Conversation</a>
    </div>
    <!-- Chat Window -->
    <div class="chat-window d-flex flex-column">
        <h2>{{ conversation.title }} (Model: {{ conversation.model_name }})</h2>
        <div class="messages" id="chat-messages">
            {% for message in messages %}
                <div class="message {% if message.sender == 'user' %}user{% else %}assistant{% endif %}">
                    <div class="message-content">
                        <p>{{ message.content|markdownify|safe }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
        <form method="post" class="mt-auto">
            {% csrf_token %}
            <div class="form-group">
                <textarea name="message" rows="3" class="form-control" placeholder="Type your message here..." required></textarea>
            </div>
            <button type="submit" class="btn btn-success">Send</button>
        </form>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<!-- Include Highlight.js and Clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var messagesDiv = document.getElementById('chat-messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Initialize Highlight.js
        hljs.highlightAll();

        // Add copy buttons to all code blocks
        document.querySelectorAll('pre').forEach(function(pre) {
            // Create copy button
            var button = document.createElement('button');
            button.className = 'copy-button';
            button.type = 'button';
            button.innerText = 'Copy';

            // Append button to pre element
            pre.insertBefore(button, pre.firstChild);

            // Initialize Clipboard.js on the button
            var clipboard = new ClipboardJS(button, {
                target: function() {
                    return pre.querySelector('code');
                }
            });

            // Change button text on success/failure
            clipboard.on('success', function() {
                button.innerText = 'Copied!';
                setTimeout(function() {
                    button.innerText = 'Copy';
                }, 2000);
            });

            clipboard.on('error', function() {
                button.innerText = 'Error';
                setTimeout(function() {
                    button.innerText = 'Copy';
                }, 2000);
            });
        });
    });
</script>
{% endblock javascripts %}